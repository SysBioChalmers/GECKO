<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of abc_max</title>
  <meta name="keywords" content="abc_max">
  <meta name="description" content="setProtPoolSize">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="#">geckomat</a> &gt; <a href="../index.html">kcat_sensitivity_analysis</a> &gt; <a href="index.html">Bayesian</a> &gt; abc_max.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src\geckomat\kcat_sensitivity_analysis\Bayesian&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>abc_max
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>setProtPoolSize</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [rmse_final,exp,simulated,growthdata,max_growth]=abc_max(ecModel,kcat_random_all,growthdata,max_growth,proc,sample_generation,j,rxn2block) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> setProtPoolSize
   Internal function in BayesianSensitivityTuning. Gets the average RMSE for 
   a certain set of growth data and kcats.

 Input:
   ecModel         ecModel that was generated by makeEcModel, or loaded from
                   an earlier run. Not compatible with ecModels generated by
                   earlier GECKO versions (pre 3.0).
   kcat_random_all Sampled kcat values
   growthdata      Growth data loaded from file.
   max_growth      Max growth data loaded from file.
   proc            Number of experiments with data
   sample_generation Total number of randomly generated kcat sets in this iteration
   j               Which experiment to use
   rxn2block       List of reactions to block, could be read from file.

 Output:
   rmse_final      The average RMSE
   exp             Metabolite export
   simulated       Result from simulation
   growthdata      The growth data
   max_growth      The max growth data (without input constraints)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="addCarbonNum.html" class="code" title="function model = addCarbonNum(model)">addCarbonNum</a>	addCarbonNum</li><li><a href="anaerobicModel_GECKO.html" class="code" title="function model = anaerobicModel_GECKO(model)">anaerobicModel_GECKO</a>	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</li><li><a href="changeMedia.html" class="code" title="function [model,pos] = changeMedia(model,c_source,media,anox,flux)">changeMedia</a>	changeMedia</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="bayesianSensitivityTuning.html" class="code" title="function ecModel = bayesianSensitivityTuning(ecModel,modelAdapter,maxIterations)">bayesianSensitivityTuning</a>	bayesianSensitivityTuning</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [rmse,exp,simulated] = rmsecal(ecModel,data,constrain,objective,rxn2block)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [rmse_final,exp,simulated,growthdata,max_growth]=abc_max(ecModel,kcat_random_all,growthdata,max_growth,proc,sample_generation,j,rxn2block)</a>
0002 <span class="comment">% setProtPoolSize</span>
0003 <span class="comment">%   Internal function in BayesianSensitivityTuning. Gets the average RMSE for</span>
0004 <span class="comment">%   a certain set of growth data and kcats.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Input:</span>
0007 <span class="comment">%   ecModel         ecModel that was generated by makeEcModel, or loaded from</span>
0008 <span class="comment">%                   an earlier run. Not compatible with ecModels generated by</span>
0009 <span class="comment">%                   earlier GECKO versions (pre 3.0).</span>
0010 <span class="comment">%   kcat_random_all Sampled kcat values</span>
0011 <span class="comment">%   growthdata      Growth data loaded from file.</span>
0012 <span class="comment">%   max_growth      Max growth data loaded from file.</span>
0013 <span class="comment">%   proc            Number of experiments with data</span>
0014 <span class="comment">%   sample_generation Total number of randomly generated kcat sets in this iteration</span>
0015 <span class="comment">%   j               Which experiment to use</span>
0016 <span class="comment">%   rxn2block       List of reactions to block, could be read from file.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% Output:</span>
0019 <span class="comment">%   rmse_final      The average RMSE</span>
0020 <span class="comment">%   exp             Metabolite export</span>
0021 <span class="comment">%   simulated       Result from simulation</span>
0022 <span class="comment">%   growthdata      The growth data</span>
0023 <span class="comment">%   max_growth      The max growth data (without input constraints)</span>
0024 
0025 nstep = sample_generation/proc;
0026 rmse_final = zeros(1,nstep);
0027 kcat_sample = kcat_random_all(:,(j-1)*nstep+1:j*nstep);
0028 
0029 
0030 <span class="comment">% get carbonnum for each exchange rxn to further calculation of error</span>
0031 <span class="keyword">if</span> ~isfield(ecModel,<span class="string">'excarbon'</span>)
0032     ecModel = <a href="addCarbonNum.html" class="code" title="function model = addCarbonNum(model)">addCarbonNum</a>(ecModel);
0033 <span class="keyword">end</span>
0034 
0035 <span class="keyword">for</span> k = 1:nstep
0036     <span class="comment">%disp(['nstep:',num2str(k),'/',num2str(nstep)])</span>
0037     kcat_random  = kcat_sample(:,k);
0038     ecModel.ec.kcat = kcat_random;
0039     ecModel = applyKcatConstraints(ecModel);
0040     
0041     <span class="comment">%% first search with substrate constraints</span>
0042     objective = <span class="string">'r_2111'</span>;
0043     <span class="keyword">if</span> ~isempty(growthdata)
0044         [rmse_1,exp_1,simulated_1] = <a href="#_sub1" class="code" title="subfunction [rmse,exp,simulated] = rmsecal(ecModel,data,constrain,objective,rxn2block)">rmsecal</a>(ecModel,growthdata,true,objective,rxn2block);
0045     <span class="keyword">else</span>
0046         rmse_1 = [];
0047         exp_1 = [];
0048         simulated_1 = [];
0049     <span class="keyword">end</span>
0050     <span class="comment">%% second search for maxmial growth rate without constraints</span>
0051     <span class="keyword">if</span> ~isempty(max_growth)  <span class="comment">% simulate the maximal growth rate</span>
0052         [rmse_2,exp_2,simulated_2] = <a href="#_sub1" class="code" title="subfunction [rmse,exp,simulated] = rmsecal(ecModel,data,constrain,objective,rxn2block)">rmsecal</a>(ecModel,max_growth,false,objective,rxn2block);
0053     <span class="keyword">else</span>
0054         rmse_2 = [];
0055         exp_2 = [];
0056         simulated_2 = [];
0057     <span class="keyword">end</span>
0058     exp = [exp_1;exp_2];
0059     simulated = [simulated_1;simulated_2];
0060     rmse_final(1,k) = mean([rmse_1,rmse_2],<span class="string">'omitnan'</span>);
0061     
0062     <span class="comment">%% only output simulated result for one generation</span>
0063     <span class="keyword">if</span> nstep ~= 1 || sample_generation ~= 1
0064         simulated = [];
0065         exp = [];
0066     <span class="keyword">end</span>
0067 <span class="keyword">end</span>
0068 <span class="keyword">end</span>
0069 
0070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0071 <a name="_sub1" href="#_subfunctions" class="code">function [rmse,exp,simulated] = rmsecal(ecModel,data,constrain,objective,rxn2block)</a>
0072 
0073     simulated = zeros(length(data(:,1)),9);
0074     
0075     <span class="keyword">for</span> i = 1:length(data(:,1))
0076         exp = cell2mat(data(:,3:11)); <span class="comment">% u sub ace eth gly pyr ethyl_acetate co2 o2</span>
0077         exp = exp.*[1,-1,1,1,1,1,1,1,-1];
0078         ex_mets = {<span class="string">'growth'</span>,[data{i,2},<span class="string">' exchange'</span>],<span class="string">'acetate exchange'</span>,<span class="string">'ethanol exchange'</span>,<span class="string">'glycerol exchange'</span>,<span class="string">'pyruvate exchange'</span>,<span class="string">'ethyl acetate exchange'</span>,<span class="string">'carbon dioxide exchange'</span>,<span class="string">'oxygen exchange'</span>};
0079         [~,idx] = ismember(ex_mets,ecModel.rxnNames);
0080         model_tmp = ecModel;
0081 
0082         model_tmp = <a href="changeMedia.html" class="code" title="function [model,pos] = changeMedia(model,c_source,media,anox,flux)">changeMedia</a>(model_tmp,<span class="string">'D-glucose'</span>,data(i,16));<span class="comment">%TODO: These are currently hard-coded for yeast-GEM, add to adapter</span>
0083         <span class="comment">%Stop import/export of acetate and acetaldehyde</span>
0084         model_tmp = changeRxnBounds(model_tmp,<span class="string">'r_1634'</span>,0,<span class="string">'b'</span>); <span class="comment">%TODO: These are currently hard-coded for yeast-GEM, add to adapter</span>
0085         model_tmp = changeRxnBounds(model_tmp,<span class="string">'r_1631'</span>,0,<span class="string">'b'</span>);
0086 
0087         <span class="keyword">if</span> strcmp(data(i,14),<span class="string">'anaerobic'</span>) ||strcmp(data(i,14),<span class="string">'limited'</span>) 
0088             model_tmp = <a href="anaerobicModel_GECKO.html" class="code" title="function model = anaerobicModel_GECKO(model)">anaerobicModel_GECKO</a>(model_tmp);
0089         <span class="keyword">end</span>
0090         <span class="keyword">if</span> strcmp(data(i,14),<span class="string">'limited'</span>) 
0091              model_tmp.lb(strcmp(model_tmp.rxnNames,<span class="string">'oxygen exchange'</span>)) = -5;<span class="comment">%TODO: Currently hard-coded for yeast</span>
0092         <span class="keyword">end</span>
0093         <span class="keyword">if</span> ~constrain
0094             <span class="comment">%No export of glucose</span>
0095             model_tmp.lb(strcmp(model_tmp.rxns,<span class="string">'r_1714'</span>)) = 0; <span class="comment">%TODO: Currently hard-coded for yeast</span>
0096             model_tmp.lb(strcmp(model_tmp.rxns,ecModel.rxns(idx(2)))) = -1000; <span class="comment">% not constrain the substrate usage</span>
0097         <span class="keyword">else</span>
0098             <span class="comment">%No export of glucose</span>
0099             model_tmp.lb(strcmp(model_tmp.rxns,<span class="string">'r_1714'</span>)) = 0;<span class="comment">%TODO: Currently hard-coded for yeast</span>
0100             <span class="keyword">if</span> isnan(exp(i,2))
0101                 model_tmp.lb(idx(2)) = -1000;
0102             <span class="keyword">else</span>
0103                 model_tmp.lb(idx(2)) = exp(i,2);
0104             <span class="keyword">end</span>
0105         <span class="keyword">end</span>
0106 
0107 
0108         model_tmp.c = double(strcmp(model_tmp.rxns, objective));
0109         sol_tmp = solveLP(model_tmp);<span class="comment">%,objective,osenseStr,prot_cost_info,tot_prot_weight,'ibm_cplex');</span>
0110         <span class="keyword">if</span> checkSolution(sol_tmp)
0111             sol(:,i) = sol_tmp.x;
0112 
0113             tmp = ~isnan(exp(i,:));
0114             excarbon = ecModel.excarbon(idx);
0115             excarbon(excarbon == 0) = 1;
0116             exp_tmp = exp(i,tmp).*excarbon(tmp);
0117             simulated_tmp = sol(idx(tmp),i)'.*excarbon(tmp); <span class="comment">% normalize the growth rate issue by factor 10</span>
0118 
0119             exp_block = zeros(1,length(setdiff(rxn2block,model_tmp.rxns(idx(2))))); <span class="comment">% all zeros for blocked exchange mets exchange</span>
0120             rxnblockidx = ismember(model_tmp.rxns,setdiff(rxn2block,model_tmp.rxns(idx(2))));
0121             simulated_block = sol(rxnblockidx,i)'.* ecModel.excarbon(rxnblockidx); <span class="comment">%</span>
0122             exp_block = exp_block(simulated_block~=0);
0123             simulated_block = simulated_block(simulated_block~=0);
0124             <span class="keyword">if</span> constrain
0125                 rmse_tmp(i) = sqrt(immse([exp_tmp,exp_block], [simulated_tmp,simulated_block]));
0126             <span class="keyword">else</span>
0127                 <span class="keyword">if</span> length(exp_tmp) &gt;= 2
0128                     rmse_tmp(i) = sqrt(immse(exp_tmp(1:2), simulated_tmp(1:2)));
0129                 <span class="keyword">else</span>
0130                     rmse_tmp(i) = sqrt(immse(exp_tmp(1), simulated_tmp(1)));
0131                 <span class="keyword">end</span>
0132 
0133             <span class="keyword">end</span>
0134             simulated(i,:) = sol(idx,i)';
0135         <span class="keyword">else</span>
0136             simulated(i,:) = NaN;
0137             rmse_tmp(i) = NaN;
0138         <span class="keyword">end</span>
0139     <span class="keyword">end</span>
0140     rmse_tmp(isnan(rmse_tmp)) = []; <span class="comment">%we just skip any case without solution, they are pretty rare, but exist</span>
0141     rmse = sum(rmse_tmp)/length(data(:,1));
0142 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>